# Booking URL Normalization (V2)

## Problem Addressed

Hotel booking links could fallback to Booking search URLs:

- Legacy behavior: `https://www.booking.com/searchresults.html?...`
- Expected behavior: direct hotel path `https://www.booking.com/hotel/{country}/{slug}.html?...`

## Implemented Approach

### 1. Centralized Booking URL Logic

**File**: `src/lib/services/bookingLinks.ts`

Main helpers:

- `isBookingDomain()`
- `isBookingHotelPath()`
- `isBookingSearchUrl()`
- `generateBookingHotelSlug()`
- `getBookingCountryCode()`
- `buildDirectBookingHotelUrl()`
- `normalizeHotelBookingUrl()`

### 2. Normalization Rules

`normalizeHotelBookingUrl()` applies these rules:

1. If URL is direct Booking `/hotel/`: keep path, inject normalized params.
2. If URL is Booking search: convert to direct `/hotel/{country}/{slug}.html`.
3. If URL is missing: generate direct slug URL.
4. If URL is Airbnb: keep unchanged.
5. If URL is non-Booking provider: keep unchanged.

### 3. Active Integration Points

- `src/lib/services/rapidApiBooking.ts`
- `src/lib/services/hotels.ts`
- `src/lib/pipeline/step7-assemble.ts`
- `src/lib/tripUtils.ts`
- `src/lib/services/linkGenerator.ts`

## Runtime Scope

- `/api/generate` is V2-only.
- New trips generated by V2 follow this policy.
- Existing saved trips are not migrated.

## UI Behavior

- Main hotel booking button label follows provider URL:
  - `booking.com` -> `Booking`
  - `airbnb.com` -> `Airbnb`
  - other -> `RÃ©server`
- Search actions stay explicit:
  - `Recherche Booking`
  - `Recherche Airbnb`

## Validation Checklist

- Hotel primary links do not use `searchresults.html`.
- Dates and guests are present on direct links:
  - `checkin`
  - `checkout`
  - `group_adults`
  - `no_rooms`
- Airbnb room links are validated (`airbnb.com/rooms/...`) before exposure.
